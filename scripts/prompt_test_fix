#!/usr/bin/env ruby

require 'fileutils'

def run_command(cmd)
  `#{cmd}`.strip
end

def find_existing_failure_class(path)
  result = run_command("rg -l 'Failed tests' #{path} 2>/dev/null | rg '[A-Z].*html'").split("\n").first
  File.basename(result, ".html").split('.').last if result
end

def run_gradle_tests_and_get_output
  full_output = `./gradlew clean test --console=plain 2>&1`
  filtered_lines = full_output.split("\n").select do |line|
    next false if line.match?(/> Task|BUILD FAILED/)
    line.match?(/FAILED|See the report at/)
  end
  filtered_lines.join("\n")
end

def parse_class_name_from_gradle(output)
  abort "No failing tests found." if output.empty?
  first_line = output.split("\n").first
  abort "Could not parse class name from: #{first_line}" unless first_line&.include?(">")
  first_line.split(">").first.strip
end

def locate_html_report(path, class_name)
  files = run_command("find #{path}/classes -name \"*#{class_name}.html\"").split("\n")
  abort "Report not found for: #{class_name}" if files.empty?
  files.first
end

def extract_failure_details(html_path)
  lines = run_command("w3m -dump #{html_path}").split("\n")

  failure_lines = []
  inside_block = false

  lines.each do |line|
    if line =~ /^Failed tests/
      inside_block = true
      next
    end
    break if line =~ /^Tests/ && inside_block
    failure_lines << line if inside_block
  end

  failure_text = failure_lines.join("\n").strip
  abort "Failure text empty." if failure_text.empty?
  failure_text
end

def format_report(class_name, failure_text)
  <<~PROMPT
    Test failure:
    """
    #{class_name}.#{failure_text}
    """
    - Check how this looks on `origin/main`!
    - Check what changed!
    - Fix the test!
  PROMPT
end

reports_path = "service/build/reports/tests/test"

class_name = find_existing_failure_class(reports_path) || parse_class_name_from_gradle(run_gradle_tests_and_get_output)
report_file = locate_html_report(reports_path, class_name)
failure_content = extract_failure_details(report_file)
puts format_report(class_name, failure_content)
