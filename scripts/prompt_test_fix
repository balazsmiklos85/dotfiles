#!/usr/bin/env ruby
# frozen_string_literal: true

require 'fileutils'

def find_existing_failure_class(path)
  return nil unless Dir.exist?(path)

  html_files = Dir.glob(File.join(path, '**', '*.html'))

  html_files.each do |file|
    content = File.read(file)
    next unless content.include?('Failed tests')

    basename = File.basename(file, '.html')
    parts = basename.split('.')
    return parts.last if parts.last =~ /^[A-Z]/
  end

  nil
end

def run_gradle_tests
  `./gradlew clean test --console=plain 2>&1`.split("\n")
                                             .reject { |line| line.include?('> Task') }
                                             .reject { |line| line.include?('BUILD FAILED') }
                                             .select { |line| line.include?('FAILED') }
                                             .join("\n")
end

def parse_class_name_from_gradle(output)
  abort 'No failing tests found.' if output.empty?
  first_line = output.split("\n").first
  abort "Could not parse class name from: #{first_line}" unless first_line&.include?('>')
  first_line.split('>').first.strip
end

def locate_html_report(path, class_name)
  files = `find #{path}/classes -name "*#{class_name}.html"`.strip.split("\n")
  abort "Report not found for: #{class_name}" if files.empty?
  files.first
end

def extract_failure_details(html_path)
  lines = `w3m -dump #{html_path}`.strip.split("\n")

  failure_lines = []
  inside_block = false

  lines.each do |line|
    if line =~ /^Failed tests/
      inside_block = true
      next
    end
    break if line =~ /^Tests/ && inside_block

    failure_lines << line if inside_block
  end

  failure_text = failure_lines.join("\n").strip
  abort 'Failure text empty.' if failure_text.empty?
  failure_text
end

def format_report(class_name, failure_text)
  <<~PROMPT
    Test failure:
    """
    #{class_name}.#{failure_text}
    """
    - Check how this looks on `origin/main`!
    - Check what changed!
    - Fix the test!
  PROMPT
end

reports_path = 'service/build/reports/tests/test'

class_name = find_existing_failure_class(reports_path) || parse_class_name_from_gradle(run_gradle_tests)
report_file = locate_html_report(reports_path, class_name)
failure_content = extract_failure_details(report_file)
puts format_report(class_name, failure_content)
